# SQL Server Expert - Query Tuning

## Otimizador de Consultas

[Link para v√≠deo Otimizador de Consultas](https://youtu.be/kE_2WSTTqoQ?si=QbHVlhyHMCCvurmM)

### Fases de Execu√ß√£o de uma Query

Quando enviamos uma instru√ß√£o para um servidor SQL Server, ela passa internamente por cinco fases de execu√ß√£o, como mostrado na figura abaixo:

![Fases de execu√ß√£o de uma instru√ß√£o T-SQL](images/FasesExecucaoInstrucaoT-SQL.png)

Vamos entender cada uma delas:

- **1¬™ fase - Parse**: Verifica a sintaxe, ou seja, se a instru√ß√£o foi escrita corretamente.
- **2¬™ fase - Resolve**: Verifica a exist√™ncia dos objetos, garantindo que n√£o haja refer√™ncias a tabelas ou colunas inexistentes. Nesta fase, o SQL Server pode transformar partes da query internamente, por exemplo, um `LIKE` se torna uma fun√ß√£o e um `BETWEEN` se transforma em uma express√£o com `AND`.
- **3¬™ fase - Optimize**: Aqui entra em a√ß√£o o componente mais importante: o "Otimizador de Consultas". Ele analisa a query, o tamanho das tabelas, os √≠ndices existentes e elabora um Plano de Execu√ß√£o, que define todos os passos necess√°rios para executar a consulta de forma eficiente.
- **4¬™ fase - Compile**: Uma vez elaborado o Plano de Execu√ß√£o, ele √© compilado.
- **5¬™ fase - Execute**: Depois de compilado, o Plano de Execu√ß√£o √© executado e os dados retornam para o usu√°rio.

### Estat√≠sticas e sua Import√¢ncia para a Otimiza√ß√£o

O otimizador de consultas do SQL Server depende de estat√≠sticas para tomar decis√µes sobre o melhor Plano de Execu√ß√£o. Essas estat√≠sticas cont√™m informa√ß√µes sobre a distribui√ß√£o dos dados dentro das tabelas e s√£o fundamentais para que o SQL Server escolha os √≠ndices e opera√ß√µes mais eficientes. Se as estat√≠sticas estiverem desatualizadas, o otimizador pode gerar um plano inadequado, afetando o desempenho das consultas.

Para garantir um desempenho otimizado, √© essencial manter as estat√≠sticas sempre atualizadas. Isso pode ser feito manualmente com comandos como:

```sql
UPDATE STATISTICS nome_da_tabela;
```

Ou automaticamente ativando a op√ß√£o `AUTO_UPDATE_STATISTICS`, permitindo que o SQL Server atualize as estat√≠sticas conforme necess√°rio.

### Tipos de Otimizadores de Consultas

Ao longo da evolu√ß√£o do SQL Server, diferentes abordagens para otimiza√ß√£o foram adotadas:

- **Rule-Based Optimizer (RBO)**: Nos prim√≥rdios do SQL Server, o processo de otimiza√ß√£o seguia regras fixas, sem considerar caracter√≠sticas espec√≠ficas do banco de dados. Esse m√©todo avaliava apenas a estrutura da query e aplicava regras predefinidas, como sempre utilizar √≠ndices quando dispon√≠veis, sem necessariamente verificar se seria a melhor escolha.

- **Cost-Based Optimizer (CBO)**: Com o avan√ßo do poder computacional, o SQL Server passou a utilizar um modelo baseado em custo. Em vez de seguir regras fixas, esse otimizador analisa estat√≠sticas detalhadas do banco de dados para decidir a abordagem mais eficiente na execu√ß√£o da query. Isso permite que ele compare m√∫ltiplas estrat√©gias antes de escolher o Plano de Execu√ß√£o mais adequado.

### Query Store e Monitoramento do Desempenho

O **Query Store** √© uma ferramenta essencial para monitorar o desempenho das queries ao longo do tempo. Ele permite armazenar hist√≥ricos de planos de execu√ß√£o e identificar mudan√ßas que possam impactar negativamente a performance. Ao utiliz√°-lo, √© poss√≠vel comparar diferentes vers√µes de um plano de execu√ß√£o e tomar decis√µes fundamentadas para otimizar queries.

### Import√¢ncia da Edi√ß√£o do SQL Server na Otimiza√ß√£o

Os Planos de Execu√ß√£o podem variar dependendo da edi√ß√£o do SQL Server utilizada. Por isso, √© altamente recomend√°vel testar e otimizar as consultas na mesma edi√ß√£o que ser√° utilizada em produ√ß√£o. A edi√ß√£o **Developer** pode ser uma √≥tima escolha para evitar problemas se a vers√£o final for **Enterprise** ou **Standard**.

---

### Conclus√£o üöÄüìñ

O otimizador de consultas do SQL Server √© um dos componentes mais cruciais para garantir efici√™ncia na execu√ß√£o de queries. Compreender suas fases e os tipos de otimizadores permite que desenvolvedores e administradores criem instru√ß√µes SQL mais eficazes, evitando desperd√≠cio de recursos e garantindo maior desempenho das aplica√ß√µes. Al√©m disso, manter estat√≠sticas atualizadas e utilizar ferramentas como **Query Store** s√£o pr√°ticas essenciais para uma otimiza√ß√£o cont√≠nua.

---
